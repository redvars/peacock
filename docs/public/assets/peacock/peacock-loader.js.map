{"version":3,"file":"peacock-loader.js","sources":["../../src/LoaderUtils.ts","../../src/peacock-loader.ts"],"sourcesContent":["interface ComponentConfig {\n  CustomElementClass?: any; // earger load\n  importPath?: string; // lazy load\n  dependencies?: string[];\n}\n\ninterface LoaderConfig {\n  prefix?: string;\n  components?: Record<string, ComponentConfig>;\n}\n\nexport { LoaderConfig };\n\nexport class LoaderUtils {\n  private _loaderConfig: LoaderConfig;\n  private _observer: MutationObserver | undefined;\n\n  constructor(private loaderConfig: LoaderConfig) {\n    this._loaderConfig = loaderConfig;\n  }\n\n  static registerComponent(tagName: string, CustomElementClass: any) {\n    if (CustomElementClass && !customElements.get(tagName)) {\n      customElements.define(tagName, CustomElementClass);\n    }\n  }\n\n  start() {\n    this.eagerLoadComponents();\n    this.lazyLoadComponents(document);\n  }\n\n  eagerLoadComponents() {\n    if (!this._loaderConfig.components) return;\n    for (const [name, value] of Object.entries(this._loaderConfig.components)) {\n      if (value.CustomElementClass)\n        LoaderUtils.registerComponent(\n          this.getFullTagName(name),\n          value.CustomElementClass,\n        );\n    }\n  }\n\n  getFullTagName(name: string) {\n    return `${this._loaderConfig.prefix}-${name}`;\n  }\n\n  async registerAsync(tagName: string): Promise<void> {\n    if (customElements.get(tagName)) return;\n\n    const baseName = tagName.replace(`${this._loaderConfig.prefix}-`, '');\n\n    if (!this._loaderConfig.components) return;\n\n    const config = this._loaderConfig.components[baseName];\n    if (!config || !config.importPath) return;\n\n    try {\n      const module = await import(config.importPath);\n\n      // Runtime definition: grabbing the class from the module\n      const CustomElementClass =\n        module.default || module[Object.keys(module)[0]];\n\n      if (CustomElementClass && !customElements.get(tagName)) {\n        customElements.define(tagName, CustomElementClass);\n      }\n\n      // Handle dependencies recursively\n      if (config.dependencies) {\n        for (const dep of config.dependencies) {\n          // eslint-disable-next-line no-await-in-loop\n          await this.registerAsync(this.getFullTagName(dep));\n        }\n      }\n    } catch (error) {\n      console.error(\n        `Unable to load <${tagName}> from ${config.importPath}`,\n        error,\n      );\n    }\n  }\n\n  async load(root: Element | Document): Promise<void> {\n    const rootTagName =\n      root instanceof Element ? root.tagName.toLowerCase() : '';\n\n    const tags = Array.from(root.querySelectorAll(':not(:defined)')).map(el =>\n      el.tagName.toLowerCase(),\n    );\n\n    if (rootTagName.includes('-') && !customElements.get(rootTagName)) {\n      tags.push(rootTagName);\n    }\n\n    const tagsToRegister = [...new Set(tags)];\n    await Promise.allSettled(\n      tagsToRegister.map(tagName => this.registerAsync(tagName)),\n    );\n  }\n\n  lazyLoadComponents(root: any) {\n    this._observer = new MutationObserver(mutations => {\n      for (const { addedNodes } of mutations) {\n        for (const node of addedNodes) {\n          if (node.nodeType === Node.ELEMENT_NODE) {\n            this.load(node as Element);\n          }\n        }\n      }\n    });\n\n    const target = root instanceof Document ? root.documentElement : root;\n    this.load(target);\n\n    this._observer.observe(target, {\n      subtree: true,\n      childList: true,\n    });\n  }\n}\n","// Eager loaded\nimport { Icon } from './icon/icon.js';\nimport { LoaderConfig, LoaderUtils } from './LoaderUtils.js';\n\nconst loaderConfig: LoaderConfig = {\n  prefix: 'p',\n  components: {\n    icon: {\n      CustomElementClass: Icon,\n    },\n    avatar: {\n      importPath: './avatar/avatar.js',\n    },\n  },\n};\n\nnew LoaderUtils(loaderConfig).start();\n"],"names":[],"mappings":"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"}